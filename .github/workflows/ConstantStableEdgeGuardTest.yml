name: ConstantStable Edge Guard Test

on:
  workflow_dispatch:
    inputs:
      equity:
        description: "Equity (USD) to write/evaluate (ex: 20476.65)"
        required: true
        default: "20000"
      trade_date:
        description: "YYYY-MM-DD (blank = today UTC)"
        required: false
        default: ""

jobs:
  edge_guard_test:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    env:
      PYTHONUNBUFFERED: "1"

      # Google Sheets (required to actually write)
      GSHEET_ID: ${{ secrets.GSHEET_ID }}
      GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
      CS_EDGE_GSHEET_TAB: "ConstantStableEdge"

      # Inputs for edge_guard.py
      EQUITY: ${{ github.event.inputs.equity }}
      TRADE_DATE: ${{ github.event.inputs.trade_date }}

      # Optional: keep defaults or tune
      # CS_EDGE_STOP_DD_PCT: "0.40"
      # CS_EDGE_STOP_LOSS_STREAK: "10"
      # CS_EDGE_ROLL_N: "30"
      # CS_EDGE_STOP_ROLL_PCT: "0.02"

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Default trade date (UTC)
        run: |
          if [ -z "${TRADE_DATE}" ]; then
            echo "TRADE_DATE=$(date -u +%F)" >> "$GITHUB_ENV"
          fi

      - name: Run edge guard only
        run: |
          python scripts/trade/ConstantStable/edge_guard.py
