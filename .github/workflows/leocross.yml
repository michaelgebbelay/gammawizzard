name: Place LeoCross

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'PLACER_MODE: NOW | SCHEDULED'
        required: true
        default: 'SCHEDULED'
  # If you want the daily schedule, uncomment and let the orchestrator gate the exact window.
  # schedule:
  #   - cron: "10 20 * * 1-5"  # 16:10 ET

concurrency:
  group: leocross-${{ github.workflow }}-${{ github.ref }}-${{ github.event.inputs.mode || 'SCHEDULED' }}
  cancel-in-progress: ${{ github.event.inputs.mode != 'NOW' }}

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install --quiet schwab-py requests google-api-python-client google-auth google-auth-httplib2

      # ---------- GUARD ----------
      - id: guard
        name: LeoCross guard
        env:
          # Mode
          PLACER_MODE: ${{ github.event.inputs.mode != '' && github.event.inputs.mode || 'SCHEDULED' }}

          # Schwab
          SCHWAB_APP_KEY:     ${{ secrets.SCHWAB_APP_KEY }}
          SCHWAB_APP_SECRET:  ${{ secrets.SCHWAB_APP_SECRET }}
          SCHWAB_TOKEN_JSON:  ${{ secrets.SCHWAB_TOKEN_JSON }}

          # GammaWizard
          GW_TOKEN:    ${{ secrets.GW_TOKEN }}
          GW_EMAIL:    ${{ secrets.GW_EMAIL }}
          GW_PASSWORD: ${{ secrets.GW_PASSWORD }}

          # Target units
          QTY_TARGET: "4"

          # Logging
          PYTHONUNBUFFERED: "1"
        run: |
          python scripts/leocross_guard.py

      # ---------- ORCHESTRATOR (routes â†’ PLACER) ----------
      - name: LeoCross orchestrator
        if: ${{ steps.guard.outputs.action != 'SKIP' }}
        env:
          # Guard outputs
          ACTION:           ${{ steps.guard.outputs.action }}
          REASON:           ${{ steps.guard.outputs.reason }}
          REM_QTY:          ${{ steps.guard.outputs.rem_qty }}
          LEGS_JSON:        ${{ steps.guard.outputs.legs_json }}
          CANON_KEY:        ${{ steps.guard.outputs.canon_key }}
          IS_CREDIT:        ${{ steps.guard.outputs.is_credit }}
          OPEN_ORDER_IDS:   ${{ steps.guard.outputs.open_order_ids }}
          SIGNAL_DATE:      ${{ steps.guard.outputs.signal_date }}

          # Mode & target
          PLACER_MODE:      ${{ github.event.inputs.mode != '' && github.event.inputs.mode || 'SCHEDULED' }}
          QTY_TARGET:       "4"
          PLACER_TIMEOUT_SEC: "180"

          # Schwab
          SCHWAB_APP_KEY:     ${{ secrets.SCHWAB_APP_KEY }}
          SCHWAB_APP_SECRET:  ${{ secrets.SCHWAB_APP_SECRET }}
          SCHWAB_TOKEN_JSON:  ${{ secrets.SCHWAB_TOKEN_JSON }}

          # Optional Sheets (non-fatal if missing)
          GSHEET_ID: ${{ secrets.GSHEET_ID }}
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}

          PYTHONUNBUFFERED: "1"
        run: |
          python scripts/leocross_orchestrator.py
