# .github/workflows/leocross-ticket.yml
# yamllint disable rule:line-length rule:truthy
name: LeoCross Ticket

on:
  workflow_dispatch:
  schedule:
    - cron: "10 17 * * 1-5"  # 1:10pm EDT
    - cron: "10 18 * * 1-5"  # 1:10pm EST
    - cron: "10 20 * * 1-5"  # 4:10pm EDT
    - cron: "10 21 * * 1-5"  # 4:10pm EST

concurrency:
  group: leocross-append
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  leocross:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install --quiet requests google-api-python-client google-auth google-auth-httplib2 pandas-market-calendars pytz

      - name: Time gate (sleep to 4:12/1:12; bypass only on manual dispatch)
        id: gate
        env:
          CONFIG_JSON: ${{ vars.CONFIG_JSON }}
        run: |
          python - <<'PY'
          import os, time, json, datetime as dt, pytz
          import pandas_market_calendars as mcal
          cfg = json.loads(os.environ.get("CONFIG_JSON","") or "{}")
          window = int(cfg.get("gates",{}).get("leocross_window_min",5))
          offset = int(cfg.get("gates",{}).get("target_offset_min",12))
          et = pytz.timezone('America/New_York')
          now = dt.datetime.now(et)
          bypass = (os.environ.get('GITHUB_EVENT_NAME','') == 'workflow_dispatch')
          ok=False; target=None; is_early='false'; reason=''
          if bypass:
              ok=True; reason='BYPASS_MANUAL'
          else:
              nyse = mcal.get_calendar('XNYS')
              sched = nyse.schedule(start_date=now.date(), end_date=now.date(), tz='America/New_York')
              if sched.empty:
                  reason='NOT_TRADING_DAY'
              else:
                  close = sched['market_close'].iloc[0]
                  target = close + dt.timedelta(minutes=offset)
                  is_early = 'true' if close.hour < 16 else 'false'
                  delta = (now - target).total_seconds()/60.0
                  if delta < 0:
                      sl = min(180, int(max(0, -delta*60))); 
                      if sl: print(f"Sleeping {sl}s to target…"); time.sleep(sl)
                      now = dt.datetime.now(et); delta = (now - target).total_seconds()/60.0
                  ok = (0 <= delta <= window); reason=f"delta={delta:.2f}min target={target.strftime('%H:%M') if target else 'NA'}"
          with open(os.environ['GITHUB_OUTPUT'],'a') as fh:
              fh.write(f"ok={'true' if ok else 'false'}\n")
          print("GATE", "ok" if ok else "skip", reason)
          PY

      - name: Run leocross → Google Sheet (A2)
        if: ${{ steps.gate.outputs.ok == 'true' }}
        env:
          CONFIG_JSON: ${{ vars.CONFIG_JSON }}
          GSHEET_ID: ${{ secrets.GSHEET_ID }}
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
          GW_AUTH_MODE: LOGIN
          GW_BASE: https://gandalf.gammawizard.com
          GW_ENDPOINT: /rapi/GetLeoCross
          GW_AUTH_EMAIL:    ${{ secrets.GW_EMAIL }}
          GW_AUTH_PASSWORD: ${{ secrets.GW_PASSWORD }}
        run: |
          python scripts/leocross_to_sheet.py

      - name: Skipped (outside gate)
        if: ${{ steps.gate.outputs.ok != 'true' }}
        run: echo "Not within gate window; no A2 write."
