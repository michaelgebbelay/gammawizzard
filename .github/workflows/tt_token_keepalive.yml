name: TT Token Keepalive

on:
  workflow_dispatch:

jobs:
  refresh:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      PYTHONUNBUFFERED: "1"

      TT_CLIENT_ID: ${{ secrets.TT_CLIENT_ID }}
      TT_CLIENT_SECRET: ${{ secrets.TT_CLIENT_SECRET }}
      TT_REDIRECT_URI: ${{ secrets.TT_REDIRECT_URI }}
      TT_BASE_URL: ${{ secrets.TT_BASE_URL }}
      TT_TOKEN_JSON: ${{ secrets.TT_TOKEN_JSON }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Refresh TT token
        run: |
          python TT/Script/tt_token_refresh.py

      - name: Persist TT token refresh
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GH_SECRET_TOKEN }}
        run: |
          if [ -f TT/Token/tt_token.json ]; then
            gh secret set TT_TOKEN_JSON -b "$(cat TT/Token/tt_token.json)" -R "$GITHUB_REPOSITORY"
            echo "Updated TT_TOKEN_JSON secret."
          else
            echo "TT token file not found, skipping TT_TOKEN_JSON update."
          fi
