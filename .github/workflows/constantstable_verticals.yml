name: ConstantStableVerticals

on:
  workflow_dispatch:

jobs:
  trade:
    runs-on: ubuntu-latest
    timeout-minutes: 12

    env:
      PYTHONUNBUFFERED: "1"

      # Schwab
      SCHWAB_APP_KEY:     ${{ secrets.SCHWAB_APP_KEY }}
      SCHWAB_APP_SECRET:  ${{ secrets.SCHWAB_APP_SECRET }}
      SCHWAB_TOKEN_JSON:  ${{ secrets.SCHWAB_TOKEN_JSON }}

      # GammaWizard
      GW_EMAIL:           ${{ secrets.GW_EMAIL }}
      GW_PASSWORD:        ${{ secrets.GW_PASSWORD }}
      GW_BASE:            "https://gandalf.gammawizard.com"
      GW_ENDPOINT:        "rapi/GetUltraPureConstantStable"

      # ConstantStable sizing
      CS_UNIT_DOLLARS: "10000"
      SIZING_DOLLARS_OVERRIDE: ""

      # Vol sizing defaults (VixOne + 7 buckets)
      CS_VOL_FIELD:  "VixOne"
      CS_VIX_BREAKS: "0.089,0.111,0.131,0.158,0.192,0.253"
      CS_VIX_MULTS:  "1,1,1,2,3,4,6"

      # Controls
      CS_TOPUP_ENABLED: "1"
      CS_GUARD_NO_CLOSE: "1"
      CS_GUARD_FAIL_ACTION: "SKIP_ALL"

      # Logging
      CS_LOG_PATH: "logs/constantstable_vertical_trades.csv"

      # Placer timing knobs
      VERT_STEP_WAIT:      "12"
      VERT_POLL_SECS:      "1.5"
      VERT_CANCEL_SETTLE:  "1.0"
      VERT_MAX_LADDER:     "3"
      VERT_DRY_RUN:        "false"
      VERT_CANCEL_TRIES:   "4"

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run ConstantStable vertical orchestrator
        run: |
          python scripts/trade/ConstantStable/orchestrator.py

      - name: Push ConstantStable trades to Google Sheets
        env:
          GSHEET_ID: ${{ secrets.GSHEET_ID }}
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
          CS_GSHEET_TAB: "ConstantStableTrades"
          CS_LOG_PATH: "logs/constantstable_vertical_trades.csv"
        run: |
          python scripts/data/cs_trades_to_gsheet.py
