name: LeoCross Append Probe

on:
  workflow_dispatch: {}

jobs:
  probe:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Google libs
        run: |
          python -m pip install --upgrade pip
          pip install --quiet google-api-python-client google-auth google-auth-httplib2

      - name: Show SA and tabs, then append
        env:
          GSHEET_ID: ${{ secrets.GSHEET_ID }}
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
        run: |
          python - << 'PY'
          import os, json, sys
          from datetime import datetime, timezone
          from google.oauth2 import service_account
          from googleapiclient.discovery import build
          from googleapiclient.errors import HttpError

          # Auth
          info = json.loads(os.environ["GOOGLE_SERVICE_ACCOUNT_JSON"])
          print("service_account_email:", info.get("client_email","?"))
          creds = service_account.Credentials.from_service_account_info(
              info, scopes=["https://www.googleapis.com/auth/spreadsheets"]
          )
          svc = build("sheets","v4",credentials=creds)

          # Metadata
          sheet_id = os.environ["GSHEET_ID"].strip()
          meta = svc.spreadsheets().get(spreadsheetId=sheet_id).execute()
          titles = [s["properties"]["title"] for s in meta.get("sheets",[])]
          print("tabs:", titles)

          tab = "leocross"
          if tab not in titles:
              print("ERROR: tab not found:", tab)
              sys.exit(1)

          # Append
          now = datetime.now(timezone.utc).isoformat()
          body = {"values": [[now, "probe"]]}
          try:
              svc.spreadsheets().values().append(
                  spreadsheetId=sheet_id,
                  range=f"{tab}!A1",
                  valueInputOption="RAW",
                  insertDataOption="INSERT_ROWS",
                  body=body
              ).execute()
              print("append: ok")
          except HttpError as e:
              print("append: http error", e)
              try:
                  print("details:", e.error_details or e.content)
              except Exception:
                  pass
              sys.exit(1)
          PY
