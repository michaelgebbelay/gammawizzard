name: Schwab Probe

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["LeoCross Ticket"]   # must match the name above
    types: [completed]

concurrency:
  group: schwab-probe-${{ github.event.workflow_run.id || github.run_id }}
  cancel-in-progress: false

jobs:
  probe:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install --quiet schwab-py google-api-python-client google-auth google-auth-httplib2

      - name: Schwab top-insert + order (read leocross row 2)
        env:
          SCHWAB_APP_KEY: ${{ secrets.SCHWAB_APP_KEY }}
          SCHWAB_APP_SECRET: ${{ secrets.SCHWAB_APP_SECRET }}
          SCHWAB_TOKEN_JSON: ${{ secrets.SCHWAB_TOKEN_JSON }}
          GSHEET_ID: ${{ secrets.GSHEET_ID }}
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
          NET_PRICE: ${{ vars.NET_PRICE }}        # optional, default 0.05
          SCHWAB_PLACE: ${{ vars.SCHWAB_PLACE }}  # set to 'place' to actually submit
        run: |
          python - << 'PY'
          import os, json, sys
          from datetime import datetime, timezone
          from google.oauth2 import service_account
          from googleapiclient.discovery import build
          from schwab.auth import client_from_token_file

          # --- Schwab session ---
          open("schwab_token.json","w").write(os.environ["SCHWAB_TOKEN_JSON"])
          c = client_from_token_file(
              api_key=os.environ["SCHWAB_APP_KEY"],
              app_secret=os.environ["SCHWAB_APP_SECRET"],
              token_path="schwab_token.json")

          # Account
          r = c.get_account_numbers(); r.raise_for_status()
          acct = r.json()[0]
          acct_hash  = acct["hashValue"]
          acct_last4 = acct["accountNumber"][-4:]

          # Quote: SPX first, fallback SPY
          def first_quote():
              for sym in ["$SPX.X","SPX","SPX.X","$SPX","SPY"]:
                  q = c.get_quote(sym)
                  if q.status_code == 200 and sym in q.json():
                      last = q.json()[sym].get("quote",{}).get("lastPrice")
                      if last is not None:
                          return sym, last
              return "SPY", None
          sym, last = first_quote()

          # Sheets client
          sa = json.loads(os.environ["GOOGLE_SERVICE_ACCOUNT_JSON"])
          creds = service_account.Credentials.from_service_account_info(sa, scopes=["https://www.googleapis.com/auth/spreadsheets"])
          s = build("sheets","v4",credentials=creds)
          sid = os.environ["GSHEET_ID"]; tab_schwab = "schwab"; tab_leo = "leocross"

          # ---- Ensure schwab header, then insert at row 2 and write the probe row ----
          header_schwab = [
            "ts","source","account_hash","account_last4","symbol","last_price",
            "signal_date","order_mode","side","qty_exec","order_type","limit_price",
            "occ_buy_put","occ_sell_put","occ_sell_call","occ_buy_call","order_id","status"
          ]
          got = s.spreadsheets().values().get(spreadsheetId=sid, range=f"{tab_schwab}!1:1").execute().get("values", [])
          if not got or got[0] != header_schwab:
              s.spreadsheets().values().update(
                spreadsheetId=sid, range=f"{tab_schwab}!1:1",
                valueInputOption="USER_ENTERED", body={"values":[header_schwab]}
              ).execute()

          meta = s.spreadsheets().get(spreadsheetId=sid).execute()
          sheet_id = None
          for sh in meta.get("sheets", []):
              if sh["properties"]["title"] == tab_schwab:
                  sheet_id = sh["properties"]["sheetId"]; break

          # insert a blank row 2, then write probe to A2
          s.spreadsheets().batchUpdate(
            spreadsheetId=sid,
            body={"requests":[{"insertDimension":{
              "range":{"sheetId":sheet_id,"dimension":"ROWS","startIndex":1,"endIndex":2},
              "inheritFromBefore": False
            }}]}
          ).execute()
          now = datetime.now(timezone.utc).isoformat()
          s.spreadsheets().values().update(
            spreadsheetId=sid, range=f"{tab_schwab}!A2",
            valueInputOption="USER_ENTERED",
            body={"values":[[now,"SCHWAB_PROBE",acct_hash,acct_last4,sym,last,"","","","","","","","","","",""]]}
          ).execute()
          print("schwab: inserted probe at A2")

          # ---- Read leocross row 2 only (latest) ----
          two_rows = s.spreadsheets().values().get(spreadsheetId=sid, range=f"{tab_leo}!A1:Z2").execute().get("values", [])
          if len(two_rows) < 2:
              print("No leocross row 2; skipping order.")
              sys.exit(0)
          leo_header = two_rows[0]
          leo_row2   = two_rows[1]
          map_idx = {name:i for i,name in enumerate(leo_header)}
          def g(col):
              i = map_idx.get(col, -1)
              return leo_row2[i] if 0 <= i < len(leo_row2) else ""

          occ_buy_put   = g("occ_buy_put")
          occ_sell_put  = g("occ_sell_put")
          occ_sell_call = g("occ_sell_call")
          occ_buy_call  = g("occ_buy_call")
          if not all([occ_buy_put,occ_sell_put,occ_sell_call,occ_buy_call]):
              print("Row 2 missing one or more leg symbols; skipping order.")
              sys.exit(0)

          # --- Idempotency: if an order row exists for the same 4 legs, skip ---
          # Legs include the expiry (e.g., SPXW_250821...), so this also scopes to the date.
          all_rows = s.spreadsheets().values().get(spreadsheetId=sid, range=f"{tab_schwab}!A1:Z100000").execute().get("values", [])
          idx = {name:i for i,name in enumerate(all_rows[0])} if all_rows else {}
          def cell(r, col):
              j = idx.get(col, -1)
              return (r[j] if 0 <= j < len(r) else "").upper()

          dup_found = False
          for r in all_rows[1:]:
              if cell(r,"source") in ("SCHWAB_ORDER","SCHWAB_PLACED"):
                  if (cell(r,"occ_buy_put")==occ_buy_put.upper() and
                      cell(r,"occ_sell_put")==occ_sell_put.upper() and
                      cell(r,"occ_sell_call")==occ_sell_call.upper() and
                      cell(r,"occ_buy_call")==occ_buy_call.upper()):
                      dup_found = True
                      break
          if dup_found:
              print("Duplicate legs already placed; skipping order.")
              sys.exit(0)

          # --- Build order from row 2 ---
          qty_exec = int((g("qty_exec") or "1"))
          side = (g("side") or "").upper()
          credit_or_debit = (g("credit_or_debit") or "").lower()
          is_credit = (credit_or_debit == "credit") or side.startswith("SHORT")
          order_type = "NET_CREDIT" if is_credit else "NET_DEBIT"
          limit = os.environ.get("NET_PRICE") or "0.05"

          legs = [
            {"instruction":"BUY_TO_OPEN","quantity":qty_exec,"instrument":{"symbol":occ_buy_put,"assetType":"OPTION"}},
            {"instruction":"SELL_TO_OPEN","quantity":qty_exec,"instrument":{"symbol":occ_sell_put,"assetType":"OPTION"}},
            {"instruction":"SELL_TO_OPEN","quantity":qty_exec,"instrument":{"symbol":occ_sell_call,"assetType":"OPTION"}},
            {"instruction":"BUY_TO_OPEN","quantity":qty_exec,"instrument":{"symbol":occ_buy_call,"assetType":"OPTION"}},
          ]
          order = {
            "orderType": order_type,
            "session": "NORMAL",
            "price": str(limit),
            "duration": "DAY",
            "orderStrategyType": "SINGLE",
            "complexOrderStrategyType": "IRON_CONDOR",
            "orderLegCollection": legs
          }

          place_flag = (os.environ.get("SCHWAB_PLACE","").lower() == "place")

          # Preview, then optionally place
          preview_http = None; place_http = None; order_id = ""
          try:
              try:
                  resp = c.preview_order(acct_hash, order)  # if supported in schwab-py
              except AttributeError:
                  import httpx
                  url = f"https://api.schwabapi.com/trader/v1/accounts/{acct_hash}/orders/preview"
                  resp = c.session.post(url, json=order)
              preview_http = resp.status_code
              body = ""
              try:
                  body = resp.text[:800]
              except Exception:
                  pass
              print("PREVIEW_HTTP", preview_http)
              print("PREVIEW_BODY", body)

              if place_flag:
                  ok = c.place_order(acct_hash, order)
                  place_http = ok.status_code
                  print("PLACE_HTTP", place_http)
                  try:
                      j = ok.json()
                      order_id = str(j.get("orderId") or j.get("order_id") or "")
                  except Exception:
                      order_id = ""
          except Exception as e:
              print("ORDER_ERROR", e)

          # Log an order row (top) so the dedupe works next time
          mode = "PLACE" if place_flag else "PREVIEW"
          s.spreadsheets().batchUpdate(
            spreadsheetId=sid,
            body={"requests":[{"insertDimension":{
              "range":{"sheetId":sheet_id,"dimension":"ROWS","startIndex":1,"endIndex":2},
              "inheritFromBefore": False
            }}]}
          ).execute()
          s.spreadsheets().values().update(
            spreadsheetId=sid, range=f"{tab_schwab}!A2",
            valueInputOption="USER_ENTERED",
            body={"values":[[
              datetime.now(timezone.utc).isoformat(),
              "SCHWAB_ORDER",
              acct_hash, acct_last4, sym, (last if last is not None else ""),
              g("signal_date"), mode, side, qty_exec, order_type, str(limit),
              occ_buy_put, occ_sell_put, occ_sell_call, occ_buy_call,
              order_id, (place_http if place_http is not None else preview_http)
            ]]}
          ).execute()

          # Summary
          from textwrap import indent as _indent
          with open(os.environ["GITHUB_STEP_SUMMARY"], "a") as f:
            f.write("### Schwab order\n\n```\n"+json.dumps(order, indent=2)+"\n```\n")
            f.write(f"- account_last4: {acct_last4}\n")
            f.write(f"- quote: {sym} = {last}\n")
            f.write(f"- read leocross row: 2\n")
            f.write(f"- mode: {mode}\n")
            f.write(f"- order_id: {order_id}\n")
          PY
